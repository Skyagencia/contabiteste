<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contabils ‚Äî Entrar</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="app">
    <div class="panel" style="max-width:720px; margin: 60px auto 0;">
      <div class="panelHead" style="border-bottom:0; padding-bottom: 0;">
        <div class="brand" style="align-items:center;">
          <div class="logo" style="overflow:hidden;">
            <img src="/icon-192.png" alt="Contabils" style="width:100%; height:100%; object-fit:cover;">
          </div>
          <div>
            <h1 style="margin:0;">Contabils</h1>
            <p class="sub" style="margin-top:6px;">Entre pra acessar seu hist√≥rico. Sem drama, sem julgamento üòÖ</p>
          </div>
        </div>
      </div>

      <div class="form" style="padding-top: 10px;">
        <div class="row">
          <div class="field grow">
            <label>Email</label>
            <input id="email" type="email" placeholder="seuemail@..." autocomplete="email" />
          </div>
          <div class="field grow">
            <label>Senha</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
        </div>

        <div class="actions">
          <button id="loginBtn" class="btn" type="button">Entrar</button>
          <button id="signupBtn" class="del" type="button">Criar conta</button>
        </div>

        <div class="actions" style="justify-content:flex-start;">
          <button id="forgotBtn" class="del" type="button">Esqueci minha senha</button>
        </div>

        <span id="authHint" class="hint"></span>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Prompt sutil de instala√ß√£o (tipo notifica√ß√£o) -->
  <div id="installPrompt" class="installPrompt" hidden>
    <div class="installPrompt__icon" aria-hidden="true">‚¨áÔ∏è</div>

    <div class="installPrompt__text">
      <div class="installPrompt__title">Instalar Contabils</div>
      <div id="installSubtitle" class="installPrompt__subtitle">Acesso r√°pido na tela inicial</div>
    </div>

    <div class="installPrompt__actions">
      <button id="installBtn" class="installPrompt__btn" type="button">Instalar</button>
      <button id="installClose" class="installPrompt__close" type="button" aria-label="Fechar">‚úï</button>
    </div>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // =========================
    // 1) CONFIG SUPABASE
    // =========================
    const SUPABASE_URL = "https://mdbsjoefzjwvkulupodb.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_XB_KfHB0KbCFdCpOpJxEqA___UNhPK0";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // 2) ELEMENTOS UI
    // =========================
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const hintEl  = document.getElementById("authHint");

    const loginBtn  = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const forgotBtn = document.getElementById("forgotBtn");

    function setHint(msg, isError=false){
      hintEl.textContent = msg || "";
      hintEl.style.color = isError ? "#ef4444" : "rgba(11,26,23,.65)";
    }

    function cleanEmail(v){
      return String(v || "").trim().toLowerCase();
    }

    // =========================
    // 3) AUTO-REDIRECT SE J√Å TIVER SESS√ÉO
    // =========================
    (async function boot(){
      try {
        const { data } = await supabaseClient.auth.getSession();
        if (data && data.session) {
          window.location.href = "/index.html";
          return;
        }
        setHint("Pronto ‚úÖ Agora √© entrar ou criar conta.");
      } catch (e) {
        setHint("Erro ao iniciar auth. Veja o console.", true);
        console.warn(e);
      }
    })();

    // =========================
    // 4) LOGIN
    // =========================
    loginBtn.onclick = async () => {
      const email = cleanEmail(emailEl.value);
      const password = passEl.value || "";

      if (!email.includes("@")) return setHint("Email inv√°lido", true);
      if (password.length < 6)  return setHint("Senha muito curta (m√≠n. 6)", true);

      setHint("Entrando...");

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

      if (error) {
        // Erros comuns: email n√£o confirmado, credenciais inv√°lidas
        return setHint(error.message || "N√£o foi poss√≠vel entrar", true);
      }

      if (data && data.session) {
        setHint("Logado ‚úÖ redirecionando...");
        window.location.href = "/index.html";
      } else {
        setHint("Confira seu email para confirmar o acesso.", false);
      }
    };

    // =========================
    // 5) SIGNUP (CRIAR CONTA)
    // =========================
    signupBtn.onclick = async () => {
      const email = cleanEmail(emailEl.value);
      const password = passEl.value || "";

      if (!email.includes("@")) return setHint("Email inv√°lido", true);
      if (password.length < 6)  return setHint("Senha muito curta (m√≠n. 6)", true);

      setHint("Criando conta...");

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          // Vai usar a URL do projeto configurada no Supabase
          // (depois a gente deixa isso premium e bonito com redirect certinho)
        }
      });

      if (error) return setHint(error.message || "Erro ao criar conta", true);

      // Se Confirm Email estiver ligado, geralmente precisa confirmar antes de logar
      setHint("Conta criada ‚úÖ Agora confirma no email e depois faz login aqui.", false);

      // UX: deixa o usu√°rio no modo login (n√£o muda a tela, s√≥ orienta)
      passEl.value = "";
    };

    // =========================
    // 6) RESET DE SENHA
    // =========================
    forgotBtn.onclick = async () => {
      const email = cleanEmail(emailEl.value);
      if (!email.includes("@")) return setHint("Digite seu email pra resetar a senha", true);

      setHint("Enviando link de recupera√ß√£o...");

      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
        // Depois a gente cria uma tela bonitinha de "reset.html"
        // Por enquanto, manda de volta pro login
        redirectTo: `${window.location.origin}/login.html`
      });

      if (error) return setHint(error.message || "Erro ao enviar recupera√ß√£o", true);

      setHint("Boa ‚úÖ Link de recupera√ß√£o enviado pro seu email.", false);
    };

    // =========================
    // 7) PWA INSTALL (sutil no login)
    // =========================
    (function setupInstallPrompt(){
      const promptEl = document.getElementById("installPrompt");
      const installBtn = document.getElementById("installBtn");
      const closeBtn = document.getElementById("installClose");
      const subtitleEl = document.getElementById("installSubtitle");

      if (!promptEl || !installBtn || !closeBtn || !subtitleEl) return;

      const DISMISS_KEY = "contabils_install_dismissed_at";
      const DISMISS_DAYS = 7;

      const now = Date.now();
      const dismissedAt = Number(localStorage.getItem(DISMISS_KEY) || 0);
      const dismissedRecently = dismissedAt && (now - dismissedAt) < DISMISS_DAYS * 24 * 60 * 60 * 1000;

      const isStandalone =
        (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
        window.navigator.standalone === true;

      if (isStandalone || dismissedRecently) return;

      let deferredPrompt = null;

      function show() { promptEl.hidden = false; }
      function hide() { promptEl.hidden = true; }

      closeBtn.addEventListener("click", () => {
        localStorage.setItem(DISMISS_KEY, String(Date.now()));
        hide();
      });

      // Android/Chrome/Edge: evento oficial
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        subtitleEl.textContent = "Acesso r√°pido na tela inicial";
        installBtn.textContent = "Instalar";
        show();
      });

      installBtn.addEventListener("click", async () => {
        // iOS fallback: instru√ß√£o
        if (!deferredPrompt) {
          alert("No iPhone: toque em Compartilhar e depois em ‚ÄúAdicionar √† Tela de In√≠cio‚Äù.");
          localStorage.setItem(DISMISS_KEY, String(Date.now()));
          hide();
          return;
        }

        deferredPrompt.prompt();
        await deferredPrompt.userChoice.catch(() => {});
        deferredPrompt = null;

        localStorage.setItem(DISMISS_KEY, String(Date.now()));
        hide();
      });

      // iOS/Safari: sem beforeinstallprompt ‚Üí mostra como ‚ÄúComo instalar‚Äù
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      if (isIOS && isSafari) {
        subtitleEl.textContent = "iPhone: Compartilhar ‚Üí Adicionar √† Tela de In√≠cio";
        installBtn.textContent = "Como instalar";
        show();
      }
    })();
  </script>
</body>
</html>
